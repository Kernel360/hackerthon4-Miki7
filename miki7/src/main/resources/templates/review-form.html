<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>영화상세보기</title>
</head>
<body>

<!-- ✅ 영화 상세 정보 추가 -->
<div>
    <h3 th:text="${movie.movieName}"></h3> <!-- 영화 제목 -->
    <p><strong>영어 제목:</strong> <span th:text="${movie.movieEnName}"></span></p>
    <p><strong>장르:</strong> <span th:text="${movie.genre}"></span></p>
    <p><strong>상영 시간:</strong> <span th:text="${movie.runTime}"></span> 분</p>
    <p><strong>줄거리:</strong> <span th:text="${movie.plot}"></span></p>
    <p><strong>평점:</strong> <span th:text="${avgScore}"></span>/5</p>
    <img th:src="${movie.poster}" alt="영화 포스터" width="200px"/>
</div>
<!-- ✅ 출연진 목록 -->
<h3>출연진</h3>
<ul>
    <li th:each="cast : ${castList}">
        <span th:text="${cast.castName}"></span> 역할 -
        <span th:text="${cast.actor.actorName}"></span>
    </li>
</ul>

<h2>리뷰 작성</h2>

<form th:action="@{/reviews/save}" method="post" th:object="${review}">
    <input type="hidden" name="movieId" th:value="${movieId}" />

    <label>제목:</label>
    <input type="text" th:field="*{reviewTitle}" required /><br>

    <label>내용:</label>
    <textarea th:field="*{reviewContent}" required></textarea><br>

    <label>평점:</label>
    <input type="number" th:field="*{reviewRating}" min="1" max="5" required /><br>

    <!-- ✅ 이미지 업로드는 추후 연결 예정 -->
    <label>이미지 URL:</label>
    <input type="text" th:field="*{reviewImage}" /><br>

    <!-- ✅ 배역 선택 (선택사항) -->
    <label>배역 선택 (선택사항):</label>
    <select name="castId">
        <option value="">영화 리뷰</option> <!-- 영화 전체에 대한 리뷰일 경우 -->
        <option th:each="cast : ${castList}" th:value="${cast.id}" th:text="${cast.castName}"></option>
    </select><br>

    <button type="submit">리뷰 작성</button>
</form>

<!-- ✅ 기존 리뷰 목록 추가 -->
<h3>기존 리뷰 목록</h3>

<!-- 리뷰가 없는 경우 메시지 표시 -->
<p th:if="${#lists.isEmpty(reviews)}">등록된 리뷰가 없습니다.</p>

<!--<table border="1" th:if="${not #lists.isEmpty(reviews)}">-->
<!--    <tr>-->
<!--        <th>구분</th> &lt;!&ndash; ✅ 추가 &ndash;&gt;-->
<!--        <th>제목</th>-->
<!--        <th>내용</th>-->
<!--        <th>평점</th>-->
<!--        <th>작성일</th>-->
<!--    </tr>-->
<!--    <tr th:each="review : ${reviews}">-->
<!--        <td>-->
<!--            <span th:if="${review.castId == null}">영화 전체 리뷰</span>-->
<!--            <span th:if="${review.castId != null}">-->
<!--                <span th:each="cast : ${castList}" th:if="${cast.id == review.castId}">-->
<!--                    <span th:text="${cast.castName}"></span> (<span th:text="${cast.actor.actorName}"></span>) 리뷰-->
<!--                </span>-->
<!--            </span>-->
<!--        </td>-->
<!--        <td th:text="${review.reviewTitle}"></td>-->
<!--        <td th:text="${review.reviewContent}"></td>-->
<!--        <td th:text="${review.reviewRating}"></td>-->
<!--        <td th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}"></td>-->
<!--    </tr>-->
<!--</table>-->

<table border="1" th:if="${not #lists.isEmpty(reviews)}">
    <tr>
        <th>구분</th>
        <th>제목</th>
        <th>내용</th>
        <th>평점</th>
        <th>작성일</th>
        <th>수정/삭제</th> <!-- ✅ 수정/삭제 버튼 추가 -->
    </tr>
    <tr th:each="review : ${reviews}">
        <td>
            <span th:if="${review.castId == null}">영화 전체 리뷰</span>
            <span th:if="${review.castId != null}">
                <span th:each="cast : ${castList}" th:if="${cast.id == review.castId}">
                    <span th:text="${cast.castName}"></span> (<span th:text="${cast.actor.actorName}"></span>) 리뷰
                </span>
            </span>
        </td>
<!--        <td th:text="${review.reviewTitle}"></td>-->
<!--        <td th:text="${review.reviewContent}"></td>-->
<!--        <td th:text="${review.reviewRating}"></td>-->
<!--        <td th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}"></td>-->
<!--        <td>-->
<!--            &lt;!&ndash; ✅ 로그인한 사용자의 ID와 리뷰 작성자의 ID가 같을 때만 버튼 표시 &ndash;&gt;-->
<!--&lt;!&ndash;            <span th:if="${review.userId == session.loginUser.id}">&ndash;&gt;-->
<!--&lt;!&ndash;            @세션이 찾아지면 이걸로 다시 수정&ndash;&gt;-->
<!--            <span th:if="${review.userId == loginUserId}">-->
<!--                <a th:href="@{/reviews/edit/{reviewId}(reviewId=${review.id})}">수정</a>-->

<!--                <form th:action="@{/reviews/delete}" method="post" style="display:inline;">-->
<!--                    <input type="hidden" name="reviewId" th:value="${review.id}" />-->
<!--                    <button type="submit" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</button>-->
<!--                </form>-->
<!--            </span>-->
<!--        </td>-->




        <td>
            <span th:id="'title-text-' + ${review.id}" th:text="${review.reviewTitle}"></span>
            <input type="text" th:id="'title-input-' + ${review.id}" th:value="${review.reviewTitle}" style="display:none;" />
        </td>
        <td>
            <span th:id="'content-text-' + ${review.id}" th:text="${review.reviewContent}"></span>
            <textarea th:id="'content-input-' + ${review.id}" style="display:none;">[[${review.reviewContent}]]</textarea>
        </td>
        <td>
            <span th:id="'rating-text-' + ${review.id}" th:text="${review.reviewRating}"></span>
            <input type="number" th:id="'rating-input-' + ${review.id}" th:value="${review.reviewRating}" min="1" max="5" style="display:none;" />
        </td>

        <!-- ✅ `hidden input` 추가 -->
        <input type="hidden" th:id="'userId-input-' + ${review.id}" th:value="${review.userId}" />
        <input type="hidden" th:id="'movieId-input-' + ${review.id}" th:value="${review.movieId}" />
        <input type="hidden" th:id="'castId-input-' + ${review.id}" th:value="${review.castId}" />


        <td th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
        <td>
    <span th:if="${review.userId == loginUserId}">
        <button th:id="'edit-btn-' + ${review.id}"
                th:attr="onclick='enableEdit(' + ${review.id} + ')'"
                style="display:inline;">수정</button>

        <button th:id="'confirm-btn-' + ${review.id}"
                th:attr="onclick='submitEdit(' + ${review.id} + ')'"
                style="display:none;">확인</button>




        <!-- 삭제 버튼 -->
        <form th:action="@{/reviews/delete}" method="post" style="display:inline;">
            <input type="hidden" name="reviewId" th:value="${review.id}" />
            <button type="submit" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</button>
        </form>
    </span>
        </td>

    </tr>
</table>



<a href="/movies">영화 목록으로 돌아가기</a>
</body>
</html>
<script th:inline="javascript">
    function enableEdit(reviewId) {

        console.log("수정 요청 - reviewId:", reviewId);


        // 기존 텍스트 숨기기
        document.getElementById('title-text-' + reviewId).style.display = 'none';
        document.getElementById('content-text-' + reviewId).style.display = 'none';
        document.getElementById('rating-text-' + reviewId).style.display = 'none';

        // 입력 필드 보이기
        document.getElementById('title-input-' + reviewId).style.display = 'inline';
        document.getElementById('content-input-' + reviewId).style.display = 'inline';
        document.getElementById('rating-input-' + reviewId).style.display = 'inline';

        // 버튼 변경 (수정 -> 확인)
        document.getElementById('edit-btn-' + reviewId).style.display = 'none';
        document.getElementById('confirm-btn-' + reviewId).style.display = 'inline';
    }

    function submitEdit(reviewId) {
        const title = document.getElementById('title-input-' + reviewId).value;
        const content = document.getElementById('content-input-' + reviewId).value;
        const rating = document.getElementById('rating-input-' + reviewId).value;
        const userId = document.getElementById('userId-input-' + reviewId).value;
        const movieId = document.getElementById('movieId-input-' + reviewId).value;
        const castId = document.getElementById('castId-input-' + reviewId).value;

        const requestBody = { // ✅ `const`로 명확하게 선언
            id: reviewId,
            reviewTitle: title,
            reviewContent: content,
            reviewRating: rating,
            userId: userId,  // ✅ userId 추가
            movieId: movieId, // ✅ movieId 추가
            castId: castId    // ✅ castId 추가

        };

        console.log("클라이언트에서 전송할 데이터:", requestBody);

        fetch('/reviews/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: reviewId, // 🔴 reviewId로 변경 // @ 지금 리뷰 아이디 reviewId 있는데 컨트롤러에 안보내짐 (완료)
                reviewTitle: title,
                reviewContent: content,
                reviewRating: rating,
                userId: userId,  // ✅ userId 추가
                movieId: movieId, // ✅ movieId 추가
                castId: castId
            })
        })
            .then(response => response.json()) // 🔥 JSON으로 응답 받기
            .then(data => {
                if (data.success) {
                    alert('리뷰가 수정되었습니다.');
                    location.reload(); // 새로고침해서 변경된 내용 반영
                } else {
                    alert('수정 실패: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('수정 중 오류가 발생했습니다.');
            });
    }

</script>
